<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BookMate | Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page">

<!-- =================== NAVBAR =================== -->
<nav class="navbar">
  <h2>üìö BookMate</h2>
  <div class="nav-actions">
    <input type="text" id="searchInput" placeholder="Search books...">
    <select id="categoryFilter"><option value="all">All Categories</option></select>
    <select id="statusFilter">
      <option value="all">All Status</option>
      <option value="available">Available</option>
      <option value="borrowed">Borrowed</option>
    </select>
    <button id="darkModeToggle">üåô</button>
    <a href="notifications.html">üîî</a>
    <button id="logoutBtn">Logout</button>
  </div>
</nav>

<!-- =================== ADD BOOK BUTTON =================== -->
<button class="add-btn" onclick="window.location.href='addBook.html'">‚ûï Add Book</button>

<!-- =================== BOOKS SECTION =================== -->
<section class="books-section">
  <h3>My Library</h3>
  <div id="bookList" class="book-grid"></div>
</section>

<!-- =================== SCRIPT =================== -->
<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { collection, query, where, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

let booksData = [];

// Check if user is logged in
onAuthStateChanged(auth, async user => {
  if (!user) return window.location.href = "login.html";
  loadBooks(user.uid);
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

// Load books from Firestore
async function loadBooks(uid) {
  const q = query(collection(db,"books"), where("userId","==",uid));
  const snapshot = await getDocs(q);
  booksData = [];
  snapshot.forEach(docSnap => booksData.push({ id: docSnap.id, ...docSnap.data() }));
  populateCategories();
  displayBooks(booksData);
}

// Display books in grid
function displayBooks(list) {
  const bookList = document.getElementById("bookList");
  bookList.innerHTML = "";

  if(list.length === 0){
    bookList.innerHTML = `<p style="text-align:center; color:#555;">No books added yet. Click ‚ûï to add your first book!</p>`;
    return;
  }

  list.forEach(book => {
    const card = document.createElement("div");
    card.className = "book-card";

    let actionsHTML = `
      <button class="edit" data-id="${book.id}">‚úèÔ∏è</button>
      <button class="delete" data-id="${book.id}">üóëÔ∏è</button>
    `;

    if(book.status === "available"){
      actionsHTML = `<button class="lend" data-id="${book.id}">ü§ù Lend</button>` + actionsHTML;
    } else if(book.status === "borrowed"){
      actionsHTML = `<button class="return" data-id="${book.id}">‚úÖ Return</button>` + actionsHTML;
    }

    card.innerHTML = `
      <img src="${book.imageUrl || 'images/books.png'}" alt="${book.title}">
      <div class="book-info">
        <h4>${book.title}</h4>
        <p>Author: ${book.author}</p>
        <p>Category: ${book.category || 'N/A'}</p>
        <p>Status: ${book.status}</p>
        ${book.status === "borrowed" ? `<p>Borrower: ${book.borrowerName}</p><p>Borrowed At: ${book.borrowDate}</p><p>Due Date: ${book.dueDate}</p>` : ''}
      </div>
      <div class="book-actions">${actionsHTML}</div>
    `;
    bookList.appendChild(card);
  });

  // Actions
  document.querySelectorAll(".delete").forEach(btn => btn.addEventListener("click", async () => {
    if(confirm("Are you sure you want to delete this book?")){
      await deleteDoc(doc(db, "books", btn.dataset.id));
      loadBooks(auth.currentUser.uid);
    }
  }));

  document.querySelectorAll(".edit").forEach(btn => btn.addEventListener("click", () => {
    localStorage.setItem("editBookId", btn.dataset.id);
    window.location.href = "addBook.html";
  }));

  document.querySelectorAll(".lend").forEach(btn => btn.addEventListener("click", async () => {
    const borrowerName = prompt("Enter the borrower's name:");
    if(!borrowerName) return alert("Borrower's name is required.");
    const borrowDate = new Date().toISOString().split('T')[0];
    const dueDate = prompt("Enter due date (YYYY-MM-DD):");
    if(!dueDate) return alert("Due date is required.");

    await updateDoc(doc(db,"books",btn.dataset.id), {
      status: "borrowed",
      borrowerName,
      borrowDate,
      dueDate
    });
    alert(`Book lent to ${borrowerName} until ${dueDate}`);
    loadBooks(auth.currentUser.uid);
  }));

  document.querySelectorAll(".return").forEach(btn => btn.addEventListener("click", async () => {
    await updateDoc(doc(db,"books",btn.dataset.id), {
      status: "available",
      borrowerName: "",
      borrowDate: "",
      dueDate: ""
    });
    alert("Book marked as returned!");
    loadBooks(auth.currentUser.uid);
  }));
}

// Populate categories for filter
function populateCategories() {
  const catFilter = document.getElementById("categoryFilter");
  const uniqueCategories = [...new Set(booksData.map(b => b.category))];
  catFilter.innerHTML = '<option value="all">All Categories</option>';
  uniqueCategories.forEach(cat => catFilter.innerHTML += `<option value="${cat}">${cat}</option>`);
}

// Apply filters & search
function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const cat = document.getElementById("categoryFilter").value;
  const status = document.getElementById("statusFilter").value;

  const filtered = booksData.filter(b =>
    b.title.toLowerCase().includes(search) &&
    (cat==="all"||b.category===cat) &&
    (status==="all"||(b.status||"available")===status)
  );

  displayBooks(filtered);
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);

// Dark mode toggle
document.getElementById("darkModeToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
});
</script>
</body>
</html>
